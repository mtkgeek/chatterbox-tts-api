version: '3.8'

services:
  chatterbox-tts:
    build:
      context: .
      dockerfile: docker/Dockerfile.cpu
    container_name: chatterbox-tts-api-cpu
    ports:
      - '${PORT:-4123}:${PORT:-4123}'
    environment:
      - PORT=${PORT:-4123}
      - HOST=${HOST:-0.0.0.0}
      - EXAGGERATION=${EXAGGERATION:-0.5}
      - CFG_WEIGHT=${CFG_WEIGHT:-0.5}
      - TEMPERATURE=${TEMPERATURE:-0.8}
      - MAX_CHUNK_LENGTH=${MAX_CHUNK_LENGTH:-280}
      - MAX_TOTAL_LENGTH=${MAX_TOTAL_LENGTH:-3000}
      
      # Ensure this matches the hardcoded volume path below
      - LONG_TEXT_DATA_DIR=/data/long_text_jobs
      
      - LONG_TEXT_MAX_LENGTH=${LONG_TEXT_MAX_LENGTH:-100000}
      - LONG_TEXT_CHUNK_SIZE=${LONG_TEXT_CHUNK_SIZE:-2500}
      - LONG_TEXT_SILENCE_PADDING_MS=${LONG_TEXT_SILENCE_PADDING_MS:-200}
      - LONG_TEXT_JOB_RETENTION_DAYS=${LONG_TEXT_JOB_RETENTION_DAYS:-7}
      - LONG_TEXT_MAX_CONCURRENT_JOBS=${LONG_TEXT_MAX_CONCURRENT_JOBS:-3}
      - VOICE_SAMPLE_PATH=/app/voice-sample.mp3
      - DEVICE=cpu
      - MODEL_CACHE_DIR=/cache
      - VOICE_LIBRARY_DIR=/voices
      - MEMORY_CLEANUP_INTERVAL=${MEMORY_CLEANUP_INTERVAL:-5}
      - CUDA_CACHE_CLEAR_INTERVAL=${CUDA_CACHE_CLEAR_INTERVAL:-3}
      - ENABLE_MEMORY_MONITORING=${ENABLE_MEMORY_MONITORING:-true}

    volumes:
      # Use a hardcoded path for the container side (right side of the colon)
      - ${VOICE_SAMPLE_HOST_PATH:-./voice-sample.mp3}:/app/voice-sample.mp3:ro
      - chatterbox-models:/cache
      - chatterbox-voices:/voices
      
      # FIXED: Removed variable substitution from the target path
      - chatterbox-longtext-data:/data/long_text_jobs

      # FIXED: Removed variable substitution from the target path
      - ${VOICE_SAMPLES_DIR:-./voice-samples}:/app/voice-samples:ro

    restart: unless-stopped

    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:4123/health']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 300s

  frontend:
    profiles: ['frontend', 'ui', 'fullstack']
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: chatterbox-tts-frontend
    ports:
      - '${FRONTEND_PORT:-4321}:80'
    depends_on:
      - chatterbox-tts
    restart: unless-stopped

volumes:
  chatterbox-models:
    driver: local
  chatterbox-voices:
    driver: local
  chatterbox-longtext-data:
    driver: local
